<ul id="task_list" th:fragment="taskListFrag(tasks)">
    <!-- Loop over top-level posts -->
    <div th:each="item : ${tasks}">
        <div th:if="${item.parent == null or item.parent == ''}" class="post">
          <div class="post-container">
            <div class="post-header">
              <b class="post-author" th:text="${item.author_id}"></b>
              <span class="post-date" th:text="${#dates.format(new java.util.Date(item.time * 1000L), 'dd.MM.yyyy HH:mm')}"></span>
            </div>
            <div class="post-text" th:text="${item.text}"></div>
            <!-- Reply button for top-level post -->
            <button th:attr="
                  hx-get='/tasks/replyForm',
                  hx-vals='{&quot;id&quot;:&quot;' + ${item.id} + '&quot;}',
                  hx-target='#reply_form_' + ${item.id},
                  hx-swap='innerHTML'">
              Reply
            </button>
          </div>
          <div>
            <div th:id="'reply_form_' + ${item.id}"></div>
            <!-- Render all replies recursively -->
            <div th:insert="fragments/taskList :: renderReplies(${tasks}, ${item.id})"></div>
        </div>
    </div>
</ul>

<!-- Recursive fragment to render replies of any parent -->
<div th:fragment="renderReplies(tasks, parentId)">
    <div th:each="reply : ${tasks}" th:if="${reply.parent == parentId}" class="reply">
         <div class="reply-container">
           <div class="reply-header">
             <b class="reply-author" th:text="${reply.author_id}"></b>
             <span class="reply-date" th:text="${#dates.format(new java.util.Date(reply.time * 1000L), 'dd.MM.yyyy HH:mm')}"></span>
           </div>
           <div class="reply-text" th:text="${reply.text}"></div>
           <!-- Reply button for this reply -->
           <button th:attr="
              hx-get='/tasks/replyForm',
              hx-vals='{&quot;id&quot;:&quot;' + ${reply.id} + '&quot;}',
              hx-target='#reply_form_' + ${reply.id},
              hx-swap='innerHTML'">
             Reply
           </button>
         </div>
          <div th:id="'reply_form_' + ${reply.id}"></div>
          <!-- Recursive call for replies to this reply -->
          <div th:insert="fragments/taskList :: renderReplies(${tasks}, ${reply.id})"></div>
    </div>
</div>
