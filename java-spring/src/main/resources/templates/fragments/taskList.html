<ul id="task_list" th:fragment="taskListFrag(tasks)">
    <div th:each="item : ${tasks}">
        <div th:if="${item.parent == null or item.parent == ''}" class="post">
            <div class="post-container">
                <div class="post-header">
                    <b class="post-author" th:text="${item.username}"></b>
                    <span class="post-date" th:text="${#dates.format(new java.util.Date(item.time * 1000L), 'dd.MM.yyyy HH:mm')}"></span>
                </div>

                <div style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 10px;">
                    <div class="post-text" th:text="${item.text}"></div>

                    <div th:if="${item.attachment != null and item.attachment != ''}">
                       <img th:src="${item.attachment}" style="max-width: 50%; height: auto; border-radius: 8px; display: block;" />
                    </div>
                </div>

                <div class="reactions">
                    <button hx-post="/tasks/like" th:data-id="${item._id}" th:data-likes="${item.likes}" onclick="likePost(this)"> Like </button>
                    <span id="likes_count_${item._id}" th:text="${item.likes}"></span>

                    <button hx-post="/tasks/dislike" th:data-id="${item._id}" th:data-dislikes="${item.dislikes}" onclick="dislikePost(this)">Dislike</button>
                    <span id="dislikes_count_${item._id}" th:text="${item.dislikes}"></span>
                </div>

                <button th:attr="hx-get='/tasks/replyForm', hx-vals='{&quot;_id&quot;:&quot;' + ${item._id} + '&quot;}', hx-target='#reply_form_' + ${item._id}, hx-swap='innerHTML'">
                    Reply
                </button>
            </div>
            <div>
                <div th:id="'reply_form_' + ${item._id}"></div>
                <div th:insert="fragments/taskList :: renderReplies(${tasks}, ${item._id})"></div>
            </div>
        </div>
    </div>
</ul>

<div th:fragment="renderReplies(tasks, parentId)">
    <div th:each="reply : ${tasks}" th:if="${reply.parent == parentId}" class="reply">
        <div class="reply-container">
            <div class="reply-header">
                <b class="reply-author" th:text="${reply.username}"></b>
                <span class="reply-date" th:text="${#dates.format(new java.util.Date(reply.time * 1000L), 'dd.MM.yyyy HH:mm')}"></span>
            </div>

            <div style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 10px;">
                <div class="reply-text" th:text="${reply.text}"></div>

                <div th:if="${reply.attachment != null and reply.attachment != ''}">
                    <img th:src="@{'/uploads/' + ${reply.attachment}}" style="max-width: 50%; height: auto; border-radius: 8px; display: block;" />
                </div>
            </div>

            <div class="reactions">
                <button hx-post="/tasks/like" th:data-id="${reply._id}" th:data-likes="${reply.likes}" onclick="likePost(this)">Like</button>
                <span id="likes_count_${reply._id}" th:text="${reply.likes}"></span>

                <button hx-post="/tasks/dislike" th:data-id="${reply._id}" th:data-dislikes="${reply.dislikes}" onclick="dislikePost(this)">Dislike</button>
                <span id="dislikes_count_${reply._id}" th:text="${reply.dislikes}"></span>
            </div>

            <button th:attr="hx-get='/tasks/replyForm', hx-vals='{&quot;_id&quot;:&quot;' + ${reply._id} + '&quot;}', hx-target='#reply_form_' + ${reply._id}, hx-swap='innerHTML'">
                Reply
            </button>
        </div>
        <div th:id="'reply_form_' + ${reply._id}"></div>
        <div th:insert="fragments/taskList :: renderReplies(${tasks}, ${reply._id})"></div>
    </div>

    <script>
        function likePost(button) {
            const id = button.getAttribute('data-id');
            const likes = button.getAttribute('data-likes');
            fetch('/tasks/like', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `id=${encodeURIComponent(id)}&likes=${encodeURIComponent(likes)}`
            }).then(response => response.text()).then(newLikes => {
                document.getElementById('likes_count_' + id).textContent = newLikes;
                button.setAttribute('data-likes', newLikes);
            });
        }
        function dislikePost(button) {
            const id = button.getAttribute('data-id');
            const dislikes = button.getAttribute('data-dislikes');
            fetch('/tasks/dislike', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `id=${encodeURIComponent(id)}&dislikes=${encodeURIComponent(dislikes)}`
            }).then(response => response.text()).then(newDislikes => {
                document.getElementById('dislikes_count_' + id).textContent = newDislikes;
                button.setAttribute('data-dislikes', newDislikes);
            });
        }
    </script>
</div>