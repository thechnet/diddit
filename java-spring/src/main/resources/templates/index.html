<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:hx-on="http://www.w3.org/1999/xhtml">
<head>
    <title>Ditto Spring Tasks Quickstart</title>
    <script src="https://unpkg.com/htmx.org@2.0.4"></script>
    <script src="https://unpkg.com/htmx-ext-sse@2.2.2"></script>
</head>
<body>
    <div id="sync-header" style="margin-bottom: 1rem;">
        <span id="sync_state"
              hx-ext="sse"
              sse-connect="/ditto/sync/state"
              sse-swap="sync_state">
                  Sync State: True
        </span>
        <button type="button" hx-post="/ditto/sync/toggle" hx-swap="none">
            Toggle
        </button>
    </div>

    <div id="form-section" style="flex: 1;">
        <h3>Add new Post</h3>
        <form hx-post="/tasks" hx-swap="none"
              hx-on::after-request="if(event.detail.successful) this.reset()">
            <input type="text" name="author_id" placeholder="Author" required
                   style="width: 100%; padding: 6px; box-sizing: border-box;" />

            <!-- Text input bigger (multiline) -->
            <input type="text" name="title" placeholder="New Post" required
                      style="width: 100%; height: 100px; padding: 6px; box-sizing: border-box;"/>
            <button type="submit">Add</button>
        </form>
    </div>


    <div style="display: flex; gap: 2rem;">
        <div id="list-section" style="flex: 1;"
             hx-ext="sse"
             sse-connect="/tasks/stream"
             sse-swap="task_list">
            <div th:replace="fragments/taskList :: taskListFrag(${tasks})"></div>
        </div>


    </div>
    <script>
        function loadReplyForm(postId) {
            console.log('Loading reply form for:', postId);

            fetch('/tasks/replyForm?id=' + postId)
                .then(response => response.text())
                .then(html => {
                    document.getElementById('reply_form_' + postId).innerHTML = html;
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }

        // Event delegation for dynamically loaded content
        document.addEventListener('click', function(event) {
            if (event.target.matches('[data-reply-button]')) {
                const postId = event.target.getAttribute('data-post-id');
                loadReplyForm(postId);
            }
        });
        function loadReplyForm(postId) {
            console.log('Reply button clicked for post:', postId);

            const targetElement = document.getElementById('reply_form_' + postId);
            console.log('Target element:', targetElement);

            if (!targetElement) {
                console.error('Target element not found: reply_form_' + postId);
                return;
            }

            console.log('Making request to /tasks/replyForm?id=' + postId);

            fetch('/tasks/replyForm?id=' + postId)
                .then(response => {
                    console.log('Response status:', response.status);
                    if (!response.ok) {
                        throw new Error('HTTP error ' + response.status);
                    }
                    return response.text();
                })
                .then(html => {
                    console.log('Received HTML response');
                    targetElement.innerHTML = html;
                    console.log('Form inserted successfully');
                })
                .catch(error => {
                    console.error('Error loading reply form:', error);
                });
        }
    </script>
</body>
</html>
